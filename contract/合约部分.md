# 合约部分

## 调用：

contract address：0x4CA400092f105d5581f9ed6918BBA0896417E173

Network: Ethereum Sepolia Testnet

ABI：见json

------

## 1. 合约概览

- 合约名：`CampusMarketplace`
- Solidity 版本：`^0.8.0`
- 管理员：合约部署者（`admin`）
- 资金模型：**托管（Escrow）**
- 用户前置条件：**钱包地址 + 已绑定校园邮箱 hash**

------

## 2. 核心数据结构

### 2.1 用户身份

```
mapping(bytes32 => address) emailToAddress;
mapping(address => bytes32) addressToEmail;
```

- `emailHash`：前端对校园邮箱做 hash（如 `keccak256(email)`）
- 一个邮箱 ↔ 一个钱包地址
- 是否已验证：`addressToEmail[user] != bytes32(0)`

------

### 2.2 商品 Listing

```
struct Listing {
    uint256 id;
    string title;
    string description;
    uint256 price;     // wei
    address seller;
    bool isActive;
    string imageHash;  // IPFS / CDN hash
}
```

- `isActive = true`：可购买
- 创建交易后会自动下架

------

### 2.3 交易 Transaction

```
enum TransactionStatus {
    Created,
    Locked,
    Disputed,
    Completed,
    Cancelled
}
struct Transaction {
    uint256 id;
    uint256 listingId;
    address buyer;
    address seller;
    uint256 amount;
    TransactionStatus status;
    address disputeInitiator;
    string disputeReason;
    uint256 createdAt;
}
```

------

## 3. 统一返回结构（重要）

除 `view` 函数外，**所有核心操作都返回统一 Response**：

```
struct Response {
    bool success;
    uint256 code;    // 200 成功 | 400 参数错误 | 401 未授权
    string message;
    uint256 data;    // 可选：返回 ID
}
```

------

## 4. 合约接口说明（按调用流程）

------

### 4.1 绑定校园邮箱（登录 / 首次使用）

```
bindEmail(bytes32 emailHash, bytes signature)
→ Response
```

**前端流程**

1. 用户对 `emailHash` 进行钱包签名
2. 调用合约绑定

**失败场景**

- 邮箱已被绑定（400）
- 签名与 `msg.sender` 不匹配（401）

------

### 4.2 登录校验（View）

```
verifyLogin(address user)
→ bool
```

- `true`：已完成校园认证
- `false`：未认证

------

### 4.3 发布商品

```
createListing(
  string title,
  string description,
  uint256 price,
  string imageHash
)
→ Response(data = listingId)
```

**限制**

- 仅已绑定邮箱用户
- `price` 单位：`wei`

------

### 4.4 创建交易（购买商品）

```
createTransaction(
  uint256 listingId,
  bytes signature
)
payable
→ Response(data = transactionId)
```

**签名内容（前端必须一致）**

```
keccak256(
  abi.encodePacked(
    listingId,
    price,
    buyer,
    seller
  )
)
```

**校验点**

- 商品必须 `isActive`
- 买卖双方都已认证
- `msg.value >= price`
- 买家不能买自己商品
- 签名者必须是买家

------

### 4.5 买家确认收货（释放资金）

```
releaseFunds(uint256 txId)
→ Response
```

- 仅买家可调用
- 状态必须是 `Locked`
- 资金直接转给卖家

------

### 4.6 取消交易（买 / 卖 任一方）

```
cancelTransaction(uint256 txId)
→ Response
```

- 状态必须是 `Locked`
- 商品重新上架
- 全额退款给买家

------

## 5. 争议与管理员功能

### 5.1 发起争议

```
raiseDispute(uint256 txId, string reason)
```

- 买家 / 卖家均可
- 状态：`Locked → Disputed`

------

### 5.2 管理员裁决争议

```
resolveDispute(uint256 txId, bool releaseToSeller)
```

- `true`：钱给卖家
- `false`：退款买家 + 商品重新上架

------

### 5.3 管理员强制下架商品

```
forceDelist(uint256 listingId)
```

------

## 6. 查询接口（View）

```
getListing(uint256 id) → Listing
getTransaction(uint256 id) → Transaction
```

------

## 7. 关键事件（前端监听）

```
EmailBound(user, emailHash)
ListingCreated(id, seller, title, price)
TransactionCreated(txId, listingId, buyer, amount)
FundReleased(txId, seller, amount)
TransactionCancelled(txId)
DisputeRaised(txId, initiator)
DisputeResolved(txId, sellerWins)
ListingForceDelisted(listingId)
```

------

## 8. 最小调用顺序示例

```
bindEmail
→ verifyLogin
→ createListing
→ createTransaction (payable)
→ releaseFunds | cancelTransaction | raiseDispute
```

